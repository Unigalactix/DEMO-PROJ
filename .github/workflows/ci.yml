name: CI Pipeline - Unigalactix/DEMO-PROJ

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CI: true

jobs:
  # JOB 1: BUILD & TEST
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Frontend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Test
        run: npm test

  # JOB 2: SECURITY SCANS
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # JOB 3: CONTAINERIZATION (Conditional)
  # Generates if deploy target is 'docker' OR 'azure-webapp'
  docker-build:
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    permissions:
      contents: read
    # Only run if secrets are configured (skip on forks or when secrets not available)
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.ACR_LOGIN_SERVER != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute lowercase repo name
        run: echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.REPO_LOWER }}:latest
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.REPO_LOWER }}:${{ github.sha }}

  # JOB 4: DEPLOYMENT (Conditional)
  # Generates if deploy target is 'azure-webapp'
  deploy:
    runs-on: ubuntu-latest
    needs: [build, security-scan, docker-build]
    environment: Production
    # Only run if secrets are configured (skip on forks or when secrets not available)
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.AZURE_WEBAPP_PUBLISH_PROFILE != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build frontend
        working-directory: Frontend
        run: |
          npm ci
          npm run build

      - name: Prepare deployment package
        run: |
          mkdir -p deploy
          cp -r Frontend/dist/* deploy/
          # Verify index.html exists
          if [ ! -f deploy/index.html ]; then
            echo "Error: index.html not found in deployment package"
            exit 1
          fi

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy
          slot-name: ${{ secrets.AZURE_WEBAPP_SLOT_NAME }}

